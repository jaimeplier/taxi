{% extends 'config/base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block style %}
{% endblock style %}
{% block content %}
<!-- <style>
		/* Set the size of the div element that contains the map */
		#map {
		width:"100%";
		height:"600px";
		border:0;
		}
</style> -->

	<!-- mapa y servicios -->
	<div class="row">
		<div class="col s12">
			<div class="row">
                <div class="col s1"></div>
				<div class="col s7">
					<div class="row">
						<div class="col s2">Ubicación:</div>
						<div class="col s8">
							<input type="text" id="searchTextField"/>
						</div>
					</div>
						<div id="map" style="width:100%;height:450px;border:1px solid #DCDCDC;"></div> 
						<!-- /.panel  -->
						<!-- <iframe src="https://www.google.com/maps/embed?pb=!1m10!1m8!1m3!1d15052.917522571319!2d-99.16222135!3d19.4024927!3m2!1i1024!2i768!4f13.1!5e0!3m2!1ses-419!2smx!4v1521092466422" width="100%" height="600px" frameborder="0" style="border:0" allowfullscreen></iframe> -->
				</div>
				<div class="col s4">
					<!--ingresar numero telefonico -->
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" id="numero_telefonico" onblur="cargarClientesTelefono()">
							<label for="numero_telefonico">Número Telefónico</label>
						</div>
					</div>
					<!-- nombre del cliente -->
					<div class="row">
						<div class="col s8">
							<select id="nombres_usuarios" onchange="cargarDirecciones()">
                                <option value=" ">Usuario</option>
							</select>
						</div>
						<div class="col s4">
							<a class="waves-effect waves-light btn">Buscar</a>
						</div>
					</div>
					<!--direccion origen, donde se encuentra el usuario -->
					<div class="row">
						<div class="col s12 input-field">
                            <select id="direccion_origen" onchange="cargarTiposVehiculos()">
                                <option value=" ">Ubicación del usuario</option>
							</select>
							<!-- <input type="text" id="direccion_origen">
                            <label for="direccion_origen">Ubicación del usuario</label> -->
						</div>
					</div>
					<!-- *****TODO : direccion fuera de registro, destino, a donde va el usuario -->
					<!-- <div class="row">
						<div class="col s12 input-field">
							<input type="text" id="direccion_destino">
							<label for="direccion_destino">Dirección destino</label>
						</div>
					</div> -->
					<!-- referencia del lugar -->
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" id="referencia_lugar">
							<label for="referencia_lugar">Referencias del lugar</label>
						</div>
					</div>
					<!-- referencias de la persona -->
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" id="referencia_persona">
							<label for="referencia_persona">Referencias de la persona</label>
						</div>
					</div>
					<!-- número de económico -->
					<div class="row">
						<div class="col s12 input-field">
							<input type="text" id="numero_economico">
							<label for="numero_economico">Número de económico</label>
						</div>
					</div>

                    <div class="row">
                        <div class="col s12 input-field">
						<select id="tipo_vehiculo">
							<option value="" disabled selected>Vehículo</option>
						</select>
                        </div>
					</div>

					<!-- costo del viaje -->
					<div class="row">
                        <div class="col s4">
                            <a class="waves-effect waves-light btn input-field" 
                            style="margin-top: 20%;" onclick="cotizar()">Cotizar</a>
                        </div>
						<div class="col s8 center" id="cotizar">
							
						</div>
					</div>
					<!-- tipo de pago -->
					<!-- <div class="row">
						<div class="col s12">
							<select id="metodo_pago">
								<option value="" disabled selected>Seleccione</option>
								<option value="1">Efectivo</option>
								<option value="2">Tarjeta</option>
							</select>
						</div>
					</div> -->
					<!-- tipo de vehiculo -->

					<!-- select's
					<div class="row">
						<div class="col s6">
							<input type="checkbox" id="reservar"/>
      						<label for="reservar">Reservar</label>
						</div>
						<div class="col s6">
							<input type="checkbox" id="cliente_preferente">
							<label for="cliente_preferente">Cliente preferente</label>
						</div>
					</div>
					-->
                        <div class="col s12 center" style="margin-top: -60px;">
                            <a class="waves-effect waves-light btn" 
                            onclick="solicitarServicio()"
                            style="margin-top: 20%;">Solicitar servicio</a>
                        </div>
				</div>
			</div>
		</div>
	</div>

{% endblock %}

{% block scripts %}
<script src="{% static "vendor/jquery-ui/jquery-ui.min.js" %}"></script>
<script type="text/javascript" src="{% static 'js/crsfajax.js' %}"></script>
<script type="text/javascript">
		// Initialize and add the map
		var map;
        var list_direcciones;
        var ciudad_id;
        var destino_text;
        var locations = [];

        {% if  latitud %}
            var lat = {{ latitud }};
            var lgn = {{ longitud }};
        {% else %}
            var lat = 19.419260;
            var lgn = -99.164379;
        {% endif %}
        var marker;

        function initMap() {
            if (map !== undefined)
                return;
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: lat, lng: lgn},
                zoom: 14
            });

            var input = /** @type {!HTMLInputElement} */(
                document.getElementById('searchTextField'));

            var types = [];

            var autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.setTypes(types);
            autocomplete.bindTo('bounds', map);

            var infowindow = new google.maps.InfoWindow();
            marker = new google.maps.Marker({
                map: map,
                draggable: true,
                anchorPoint: new google.maps.Point(0, -29),
                // position: {lat: lat, lng: lgn},
            });

            marker.addListener('dragend', function () {
                lat = this.position.lat();
                lgn = this.position.lng();
                $('#lat').val(lat);
                $('#lgn').val(lgn);

                // geocodePosition(marker.getPosition());

                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                        latLng: marker.getPosition()
                    }, 
                        function(results, status) 
                        {
                            if (status == google.maps.GeocoderStatus.OK) 
                            {
                                destino_text = results[0].formatted_address     
                            } 
                        }
                    );
            });
            
            marker.setVisible(true);

            autocomplete.addListener('place_changed', function () {
                infowindow.close();
                marker.setVisible(false);
                var place = autocomplete.getPlace();
                if (!place.geometry) {
                    window.alert("Autocomplete's returned place contains no geometry");
                    return;
                }
                // If the place has a geometry, then present it on a map.
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);  // Why 17? Because it looks good.
                }
                marker.setPosition(place.geometry.location);
                marker.setVisible(true);

                lat = place.geometry.location.lat()
                lgn = place.geometry.location.lng();

                $('#lat').val(lat);
                $('#lgn').val(lgn);

            });
        }
</script>
		

<script type="text/javascript">
	$("document").ready(function(){
		$(".dropdown-button").dropdown();
		$(".button-collapse").sideNav();
    	$('select').material_select();

            $.ajax({
			url: "/ws/list_vehiculos_activos/",
			type: "GET", 
			cache: false,
			success: function (json) {
                json.map(function(el){
                    locations.push({
                        lat: el.chofer.latlgn.coordinates[1],
                        lng: el.chofer.latlgn.coordinates[0]})
                })
                // var locations = [
                //     {lat: +origen_lat, lng: +origen_lon},
                //     {lat: +destino_lat, lng: +destino_lon},
                // ];

                // map.setCenter({
                //             lat: +origen_lat,
                //             lng: +origen_lon
                //         });

                var markers = locations.map(function(location) {
                return new google.maps.Marker({
                    position: location,
                });
                });

                // var markerCluster = new MarkerClusterer(map, markers,
                //     {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
            
            }
		});
	});

	function cargarClientesTelefono() {
		var numTelefono = $('#numero_telefonico').val();
		if ( numTelefono != " " && numTelefono != null ) {
            $.ajax({
                url: "/ws/buscarTelefonoCliente/?telefono=" + numTelefono,
                type: "GET", // http method
                cache: false,
                // handle a successful response
                success: function (json) {
                    $("#nombres_usuarios").empty().html(' ');
                    $('#nombres_usuarios').append(
                        $("<option></option>")
                            .attr("value", "")
                            .text("Usuario")
                    );
                    for (i in json) {
                        $('#nombres_usuarios').append(
                            $("<option></option>")
                                .attr("value", json[i].pk)
                                .text(json[i].nombre + ' ' + json[i].a_paterno)
                        );
                    }
                    $('#nombres_usuarios').material_select();
                },
                // handle a non-successful response
                error: function (xhr, errmsg, err) {
                    alert("No hay usuarios registrados con ese numero");
                }
            });
        }
	}

	function cargarDirecciones() {
		var id_usuario = $('#nombres_usuarios').val();
		
            $.ajax({
                url: "/ws/direccion/?cliente=" + id_usuario,
                type: "GET", // http method
                cache: false,
                // handle a successful response
                success: function (json) {
                    list_direcciones = json;
                    $("#direccion_origen").empty().html(' ');
                    $('#direccion_origen').append(
                        $("<option></option>")
                            .attr("value", "")
                            .text("Ubicación del usuario")
                    );
                    for (i in json) {
                        $('#direccion_origen').append(
                            $("<option></option>")
                                .attr("value", json[i].id)
                                .text(json[i].direccion )
                        );
                    }
                    $('#direccion_origen').material_select();
                }
            });
    }
    
    function cotizar() {
        if (!list_direcciones) {
            alert("Agrega una dirección de origen")
            return
        }

        var direccion_usuario = list_direcciones.find(
            el => el.id == $('#direccion_origen').val());

        // new Date().toJSON().slice(0,10).replace(/-/g,'/'),
        var data_cotizar = {
            fecha: new Date().toJSON(),
            // fecha: "2019-06-20 18:52",
            ciudad: ciudad_id,	
            tipo_vehiculo: $('#tipo_vehiculo').val(),
            tipo_servicio: "1",
            sucursal: null,
            base: null,
            // lon_origen: -99.18240007013083,
            // lat_origen: 19.413000142702117,
            // lon_destino: -99.18240007013083,
            // lat_destino: 19.413000142702117

            lat_origen: direccion_usuario.latitud,
            lon_origen: direccion_usuario.longitud,
            lat_destino: lat,	
            lon_destino: lgn
        }
        $.ajax({
                url: "/ws/cotizar/" ,
                type: "POST",
                cache: false,
                data: data_cotizar,
                success: function (json) {
                    $('#cotizar').empty();
                    $('#cotizar').append(`
                        <p> <b>Precio: $</b>`+ Math.ceil(json.precio) + `</p>
                        <p> <b>Distancia: </b>`+ json.distance_text + `</p>
                        <p> <b>Duración: </b>`+ json.duracion_text + `</p>
                    `)
                },
                error: function (xhr, errmsg, err) {
                    alert(errmsg, err);
                }
        });
    }

    
    function solicitarServicio() {
        if (!list_direcciones) {
            alert("Agrega una dirección de origen")
        }

        var direccion_usuario = list_direcciones.find(
            el => el.id == $('#direccion_origen').val());
        
        var data_cotizar = {
            fecha: new Date().toJSON(),
            ciudad: ciudad_id,	
            tipo_vehiculo: $('#tipo_vehiculo').val(),
            tipo_servicio: "1",
            sucursal: null,
            base: null,
            lat_origen: direccion_usuario.latitud,
            lon_origen: direccion_usuario.longitud,
            lat_destino: lat,	
            lon_destino: lgn
        }


            $.ajax({
                url: "/ws/cotizar/" ,
                type: "POST",
                cache: false,
                data: data_cotizar,
                success: function (json) {

                    var origen_usuario = list_direcciones.find(
                        el => el.id == $('#direccion_origen').val());
                    // new Date().toJSON().slice(0,10).replace(/-/g,'/'),
                    var data_solicitar = {
                        hora_servicio : new Date().toJSON(),
                        origen: origen_usuario.direccion,
                        destino: destino_text,
                        direccion_origen : origen_usuario.direccion,
                        direccion_destino: destino_text,
                        ref_lugar : $('#referencia_lugar').val() ,
                        ref_persona	: $('#referencia_persona').val(),
                        distancia : json.distance ,
                        tiempo_aproximado_servicio : json.duracion ,
                        costo : json.precio,
                        tipo_servicio : 1 ,
                        sitio : json.tarifa.sitio,
                        tipo_pago: 2,	
                        tarifa 	: json.tarifa.tarifa_base,
                        tarjeta : null,
                        // fecha: "2019-06-20 18:52",
                    }

                    $.ajax({
                        url: "/ws/solicitar/" ,
                        type: "POST",
                        cache: false,
                        data: data_solicitar,
                        success: function (res) {
                            console.log('res solicitar',res)
                        },
                        error: function (xhr, errmsg, err) {
                            alert(errmsg, err);
                        }
                    });

                },
                error: function (xhr, errmsg, err) {
                    alert(errmsg, err);
                }
        });

      

        
    }


	function cargarTiposVehiculos() {
        var direccion_usuario = list_direcciones.find(
            el => el.id == $('#direccion_origen').val());
		var latLng = {
            latitud: direccion_usuario.latitud ,
            longitud: direccion_usuario.longitud
        };

        marker.setMap(null);

        marker = new google.maps.Marker({
                map: map,
                draggable: true,
                anchorPoint: new google.maps.Point(0, -29),
                position: {
                    lat: +direccion_usuario.latitud, 
                    lng: +direccion_usuario.longitud},
                });
                
                map.setCenter({
                    lat: +direccion_usuario.latitud, 
                    lng: +direccion_usuario.longitud
                });

            $.ajax({
                url: "/ws/buscarCiudad/" ,
                type: "POST",
                cache: false,
                data: latLng,
                success: function (json) {
                    ciudad_id = json.id;
                    $.ajax({
                        url: "/ws/tipoVehiculo/?ciudad=" + json.id,
                        type: "GET",
                        cache: false,
                        success: function (json) {
                            $("#tipo_vehiculo").empty().html(' ');
                            $('#tipo_vehiculo').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Vehículo")
                            );
                            for (i in json) {
                                $('#tipo_vehiculo').append(
                                    $("<option></option>")
                                        .attr("value", json[i].id)
                                        .text(json[i].nombre )
                                );
                            }
                            $('#tipo_vehiculo').material_select();
                        }
                    });
                }   
            });

            $.ajax({
			url: "/ws/list_vehiculos_activos/",
			type: "GET", 
			cache: false,
			success: function (json) {
                locations = [];
                json.map(function(el){
                    locations.push({
                        lat: el.chofer.latlgn.coordinates[1],
                        lng: el.chofer.latlgn.coordinates[0]})
                })
                // var locations = [
                //     {lat: +origen_lat, lng: +origen_lon},
                //     {lat: +destino_lat, lng: +destino_lon},
                // ];

                // map.setCenter({
                //             lat: +origen_lat,
                //             lng: +origen_lon
                //         });

                var markers = locations.map(function(location) {
                return new google.maps.Marker({
                    position: location,
                });
                });

            var markerCluster = new MarkerClusterer(map, markers,
                {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
                });
            }        
		});

	}
</script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"> </script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYY4fBmf4bsSTaWS7AArMpXtPiz4Iy9Gs&libraries=places&callback=initMap"></script>
{% endblock %}
<!-- Developed By Softic Web Team -->